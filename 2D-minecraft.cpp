#include <Adafruit_GFX.h>    // Core graphics library
#include <Adafruit_ST7735.h> // Hardware-specific library for ST7735
#include <SPI.h>
#include "esp_system.h"
#define TFT_CS        5
#define TFT_RST        4 // Or set to -1 and connect to Arduino RESET pin
#define TFT_DC         2
#define SCREEN_WIDTH 160 // OLED display width, in pixels
#define SCREEN_HEIGHT 128 // OLED display height, in pixels
Adafruit_ST7735 tft = Adafruit_ST7735(TFT_CS, TFT_DC, TFT_RST);

#define but1 33
#define but2 32
#define but3 25
#define joyy 35
#define joyx 34

#define WorldW 128
#define WorldH 128
#define Surface 32
#define numOre 4

//шансы генерации блоков под землей (умножены на 10)
#define chanceStone 200   //15%
#define chanceOre1 50   //5%
#define chanceOre2 20   //2%
#define chanceOre3 10   //1%
#define chanceOre4 5   //0.5%

//--------Значения регистра блока-------------------

#define BROKEN   (1<<0) // сломан (пустота)
#define MOVABLE  (1<<1) // может двигаться (жидкость/песок)
#define RENDERED (1<<2) // прорисован
#define UNBREAKABLE (1<<3) // нельзя сломать
#define NO_COLLISION (1<<4) // можно пройти сквозь (задний фон, лестница)
#define ADD_BUFFER (1<<5)  //блок уже добавлен в буффер жидкости

//--------------------------------------------------

bool needRender;
uint16_t playerX = WorldW/2;
uint16_t playerY = Surface-1;
uint64_t tmr = 0;
uint64_t gravityTmr = 0;
uint64_t liquidTmr = 0;
uint64_t renderTmr = 0;

//---------------liquid system----------------------
#define liquidBufferSize 100
#define liquidUpdate 100
uint16_t activeCount = 0;
uint8_t liquidBuffer[2][liquidBufferSize];          //1-x 2-y
//---------------liquid system----------------------

#define numOfSprites 13

void mainMenu() {
  int counter = 0;
  uint64_t tmr3 = 0;

  bool worldType;
  tft.setTextSize(1);   
  tft.setTextColor(ST7735_WHITE);
  tft.setCursor(0,counter*16);
  tft.print(">");
  tft.setCursor(16,0);
  tft.print("Start");
  tft.setCursor(16,16);
  tft.print("Generate type:");
  tft.print(" flat");
  while(true) {
    if (millis()-tmr3 >= 300) {
      tmr3 = millis();
      if (analogRead(joyy) >= 2500) {     //вверх
        if (counter > 0) {
          tft.setTextColor(ST7735_BLACK);
          tft.setCursor(0,counter*16);
          tft.print(">");
          counter--;
          tft.setTextColor(ST7735_WHITE);
          tft.setCursor(0,counter*16);
          tft.print(">");
        }
      }else if(analogRead(joyy) <= 800) {     //вниз
        if (counter < 2) {
          tft.setTextColor(ST7735_BLACK);
          tft.setCursor(0,counter*16);
          tft.print(">");
          counter++;
          tft.setTextColor(ST7735_WHITE);
          tft.setCursor(0,counter*16);
          tft.print(">");
        }
      }
      if (counter == 1) {
        if (digitalRead(but1) == 1) {
          worldType = !worldType;
          tft.fillScreen(ST77XX_BLACK);
          tft.setCursor(0,counter*16);
          tft.print(">");
          tft.setCursor(16,0);
          tft.print("Start");
          tft.setCursor(16,16);
          tft.print("Generate type:");
          if (worldType) {
            tft.print("flat");
          }else{
            tft.print("usual");
          }
        }
      }
    }
  }
}




const uint16_t sprites[numOfSprites][64] PROGMEM = {
  {
    //земля с травой 0
  0x8eeb, 0x8eeb, 0x96eb, 0xcfee, 0xcfee, 0x8eeb, 0x96eb, 0xcfee,
  0x8eeb, 0x96eb, 0xcfed, 0x8eeb, 0x8eeb, 0x8eeb, 0x8eeb, 0x8eeb,
  0x8eeb, 0x8eeb, 0x8eeb, 0x3d2e, 0x3d0e, 0x8eeb, 0x8eeb, 0x3d2e, 
  0x3d0e, 0x3d0e, 0x3d0e, 0xc619, 0xab8e, 0x3d0e, 0x3d0e, 0x3d0e,
  0xcc30, 0x3d0e, 0x92cb, 0xab8e, 0xab8e, 0xab8e, 0xcc30, 0xcc30,
  0xab8e, 0xab8e, 0x92cb, 0xab8e, 0x92cb, 0xc5f9, 0xab8e, 0xab8e, 
  0x92cb, 0xcc30, 0xab8e, 0x92cb, 0x92cb, 0x92cb, 0x92cb, 0xab8e,
  0x92cb, 0x92cb, 0x92cb, 0x92cb, 0x92cb, 0x92cb, 0x92cb, 0x92cb
  },
  {
    //земля 1
  0x92cb, 0x92cb, 0x92cb, 0x92cb, 0x92cb, 0x92cb, 0x92cb, 0x92cb,
  0x92cb, 0x92cb, 0xab8e, 0x92cb, 0x92cb, 0x92cb, 0xab8e, 0x92cb,
  0x92cb, 0xab8e, 0x92cb, 0xab8e, 0x92cb, 0x92cb, 0x92cb, 0x92cb, 
  0x92cb, 0x92cb, 0xab8e, 0x92cb, 0x92cb, 0x92cb, 0x92cb, 0x92cb,
  0x92cb, 0x92cb, 0x92cb, 0x92cb, 0x92cb, 0xab8e, 0x92cb, 0xab8e,
  0x92cb, 0x92cb, 0x92cb, 0x92cb, 0xab8e, 0x92cb, 0xab8e, 0x92cb, 
  0x92cb, 0x92cb, 0x92cb, 0x92cb, 0x92cb, 0xab8e, 0x92cb, 0xab8e,
  0xab8e, 0x92cb, 0x92cb, 0x92cb, 0xab8e, 0x92cb, 0xab8e, 0x92cb
  },
  {
    //камень 2
  0xc61a, 0x630e, 0x5aed, 0x2946, 0x2126, 0x2126, 0x2126, 0x2126,
  0x630e, 0x630e, 0x630e, 0x5aed, 0x2946, 0x4209, 0x2126, 0x2126,
  0xc61a, 0x630e, 0x630e, 0x630e, 0x4209, 0x2946, 0x4209, 0x2126, 
  0xc61a, 0xc61a, 0xc619, 0x630e, 0x630e, 0x4209, 0x2946, 0x2126,
  0x8412, 0xc61a, 0x8412, 0xbdf9, 0x630e, 0x630e, 0x5aed, 0x2946,
  0xc61a, 0xffff, 0xc61a, 0x7bf2, 0x630e, 0x630e, 0x630e, 0x630e, 
  0xffff, 0x632e, 0xffff, 0xc61a, 0xc61a, 0x630e, 0xbdf9, 0x630e,
  0x8412, 0xffff, 0x630e, 0x7bf2, 0xc61a, 0xc61a, 0x630e, 0x630e
  },
  {
    //туф 3
  0xc61a, 0xc61a, 0x7bf1, 0x7bf2, 0x7bf2, 0x7bf2, 0x7bf2, 0x7bf2,
  0x7bf2, 0x7bf2, 0x7bf2, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a,
  0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xfffd, 0xc61a, 0x8412, 0xc61a, 
  0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xfffd, 0xc61a, 0xc61a,
  0x7bf1, 0x7bf2, 0x7bf2, 0x7bf2, 0x7bf2, 0x7bf2, 0x7bf2, 0x7bf2,
  0x7bf2, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 
  0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0x7bf2, 0x7bf1, 0x7bf1,
  0xc61a, 0x7bf2, 0xc61a, 0x7bf2, 0x7bf1, 0x7bf1, 0x7bf1, 0x7bf1
  },
  {
    //руда1 4
  0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a,
  0xc61a, 0xc61a, 0x7bf1, 0x7bf1, 0xc61a, 0xc61a, 0xc61a, 0xc61a,
  0xc61a, 0xc619, 0x422a, 0x422a, 0xc619, 0xc61a, 0x7bf2, 0x7bf2, 
  0xc61a, 0x422a, 0x422a, 0x422a, 0x422a, 0xc61a, 0xc61a, 0xc61a,
  0xc61a, 0xc619, 0xc619, 0x7bf2, 0x7bf1, 0xc61a, 0xc61a, 0xc61a,
  0xc61a, 0x422a, 0x422a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 
  0xc61a, 0xc619, 0xc61a, 0xc61a, 0xc61a, 0x422a, 0x422a, 0xc61a,
  0x422a, 0x422a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a
  },
  {
    //руда2 5
  0xc61a, 0x81cd, 0x7bf1, 0xc61a, 0xba50, 0xfb52, 0xfb73, 0xc61a,
  0xc61a, 0xc61a, 0xc61a, 0xc61a, 0x81ad, 0xba50, 0xfb52, 0xc61a,
  0xc61a, 0x81cd, 0x81cd, 0xc61a, 0x81cd, 0x81ad, 0xba50, 0xc61a, 
  0xc61a, 0x7bf1, 0x7bf1, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a,
  0xba50, 0xfb52, 0xfb73, 0xc61a, 0x81cd, 0xba50, 0xc61a, 0xc61a,
  0x81ad, 0xba50, 0xfb52, 0xc61a, 0xc61a, 0x7bf1, 0x630e, 0xc61a, 
  0x81ad, 0x81ad, 0xba50, 0xc61a, 0xc61a, 0xba50, 0xfb52, 0xc61a,
  0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0x81ad, 0xba50, 0xc61a
  },
  {
    //руда3 6
  0xc61a, 0xcfee, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a,
  0x3d2e, 0x8eeb, 0xcfee, 0xc61a, 0xc61a, 0xcfee, 0xc61a, 0xc61a,
  0xc61a, 0x3d0e, 0x7c11, 0xc61a, 0x3d0e, 0x8eeb, 0xcfee, 0xc61a, 
  0xc61a, 0xc61a, 0xc61a, 0xc61a, 0x7bf1, 0x3d2e, 0xc61a, 0xc61a,
  0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a,
  0xc61a, 0xc61a, 0xcfee, 0xc61a, 0xc61a, 0x96eb, 0xcfee, 0xc61a, 
  0xc61a, 0x3d0e, 0x8eeb, 0xcfee, 0xc61a, 0x7c11, 0x3d2e, 0xc61a,
  0xc61a, 0x7bf1, 0x3d0e, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a
  },
  {
    //руда4 7
  0x49ef, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a, 0xc61a,
  0x7bf2, 0xc61a, 0xc61a, 0x4d3f, 0x4d3f, 0xc61a, 0x553f, 0xc61a,
  0xc61a, 0xc61a, 0x49ef, 0x4ad5, 0x4d3f, 0xc61a, 0x7c12, 0xc61a, 
  0xc61a, 0xc61a, 0x49ef, 0x49ef, 0x7bf2, 0xc61a, 0xc61a, 0xc61a,
  0xc61a, 0xc61a, 0x7bf2, 0x7bf2, 0xc61a, 0xc61a, 0xc61a, 0xc61a,
  0xc61a, 0x4d3f, 0x4d3f, 0xc61a, 0x553f, 0xc61a, 0xc61a, 0x4d3f, 
  0x49ef, 0x4ad5, 0x4d3f, 0xc61a, 0xc61a, 0xc61a, 0x49ef, 0x4ad5,
  0x41cf, 0x49ef, 0x7bf2, 0xc61a, 0xc61a, 0xc61a, 0x49ef, 0x41cf
  },
  {
    //небо 8
  0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff,
  0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff,
  0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff,
  0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff,
  0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff,
  0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff,
  0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff, 0x5ff
  },
  {
    //земля/фон 9
  0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164,
  0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164,
  0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 
  0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164,
  0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164,
  0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 
  0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164,
  0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164, 0x4164
  },
  {
    //Лестница 10
  0xc618, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0xc618,
  0xc618, 0x6b4d, 0x6b4d, 0x6b4d, 0x6b4d, 0x6b4d, 0x6b4d, 0xc618,
  0xc618, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0xc618, 
  0xc618, 0x6b4d, 0x6b4d, 0x6b4d, 0x6b4d, 0x6b4d, 0x6b4d, 0xc618,
  0xc618, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0xc618,
  0xc618, 0x6b4d, 0x6b4d, 0x6b4d, 0x6b4d, 0x6b4d, 0x6b4d, 0xc618, 
  0xc618, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0xc618,
  0xc618, 0x6b4d, 0x6b4d, 0x6b4d, 0x6b4d, 0x6b4d, 0x6b4d, 0xc618
  },
  {
    //Песок 11
	0xdeb5, 0xce13, 0xcdf2, 0xd674, 0xd654, 0xd674, 0xd695, 0xdeb5,
  0xd695, 0xc590, 0xcdd1, 0xce13, 0xce13, 0xcdf2, 0xcdd1, 0xce12,
  0xcdd1, 0xde96, 0xce33, 0xd654, 0xd654, 0xd654, 0xce12, 0xd694, 
	0xcdf2, 0xce12, 0xcdf2, 0xcdf2, 0xcdd1, 0xcdf2, 0xd633, 0xcdd1,
  0xd653, 0xce12, 0xce33, 0xc590, 0xce12, 0xcdf2, 0xce12, 0xcdf2,
  0xcd90, 0xce12, 0xd674, 0xcdf2, 0xd694, 0xd653, 0xcdf2, 0xce12, 
	0xd654, 0xd654, 0xd633, 0xd653, 0xd654, 0xd654, 0xce13, 0xce13,
  0xd674, 0xd674, 0xd674, 0xd633, 0xd653, 0xce12, 0xce13, 0xce12
  },
  {
    //игрок 12
  0xd69a, 0xc618, 0xc618, 0xc618, 0xc618, 0xc618, 0xc618, 0xd69a,
  0xdedb, 0x8c71, 0x8410, 0x8410, 0x8410, 0x8410, 0x8c71, 0xce79,
  0xc618, 0x8410, 0xdedb, 0xdefb, 0xdefb, 0xffff, 0x8410, 0xc618, 
  0xc618, 0x8410, 0xc638, 0xd69a, 0xdefb, 0xdefb, 0x8410, 0xc618,
  0xc618, 0x8410, 0xbdd7, 0xd69a, 0xd69a, 0xdedb, 0x8410, 0xc618,
  0xc618, 0x7bef, 0x9492, 0x8c71, 0xad55, 0xce59, 0x8410, 0xc618, 
  0xc618, 0x8430, 0x8410, 0x8410, 0x8410, 0x8410, 0x8430, 0xc618,
  0xce59, 0xd69a, 0xc618, 0xc618, 0xc618, 0xc618, 0xc618, 0xc638
  }
};

typedef struct __attribute__((packed)) {
  uint8_t type;
  uint8_t flags;  // 0-сломан, 1-может двигаться, 2-прорисован, 3-не может сломаться, 4-нет колизии
} Block;

const uint16_t Depth_Bar_16x128[] PROGMEM = {
  0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x738e, 0x738e, 0x738e, 0x738e, 0x738e, 0x738e, 0x738e, 0x738e, 0x738e, 0x738e, 0x738e, 0x738e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x73ae, 0x73ae, 0x73ae, 0x73ae, 0x73ae, 0x73ae, 0x73ae, 0x73ae, 0x73ae, 0x73ae, 0x73ae, 0x738e, 0x4209, 0x4209, 0x4209, 0x4209, 0x7bcf, 0x7bcf, 0x7bcf, 0x7bcf, 0x7bcf, 0x7bcf, 
  0x7bcf, 0x7bcf, 0x7bcf, 0x7bcf, 0x7bcf, 0x73af, 0x4209, 0x4209, 0x4209, 0x4209, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x7bef, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x8410, 0x8410, 0x8410, 0x8410, 0x8410, 0x8410, 0x8410, 0x8410, 0x8410, 0x8410, 0x8410, 0x8410, 0x4209, 0x4209, 0x4209, 0x4209, 0x8430, 0x8430, 0x8430, 0x8430, 0x8430, 0x8430, 
  0x8430, 0x8430, 0x8430, 0x8430, 0x8430, 0x8430, 0x4209, 0x4209, 0x4209, 0x4209, 0x8431, 0x8c51, 0x8c51, 0x8c51, 0x8c51, 0x8c51, 0x8c51, 0x8c51, 0x8c51, 0x8c51, 0x8c51, 0x8430, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x8c71, 0x8c71, 0x8c71, 0x8c71, 0x8c71, 0x8c71, 0x8c71, 0x8c71, 0x8c71, 0x8c71, 0x8c71, 0x8c71, 0x4209, 0x4209, 0x4209, 0x4209, 0x9492, 0x9492, 0x9492, 0x9492, 0x9492, 0x9492, 
  0x9492, 0x9492, 0x9492, 0x9492, 0x9492, 0x9492, 0x4209, 0x4209, 0x4209, 0x4209, 0x94b2, 0x94b2, 0x94b2, 0x94b2, 0x94b2, 0x94b2, 0x94b2, 0x94b2, 0x94b2, 0x94b2, 0x94b2, 0x94b2, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x9cd3, 0x9cd3, 0x9cd3, 0x9cd3, 0x9cd3, 0x9cd3, 0x9cd3, 0x9cd3, 0x9cd3, 0x9cd3, 0x9cd3, 0x9cd3, 0x4209, 0x4209, 0x4209, 0x4209, 0x9cf3, 0x9cf3, 0x9cf3, 0x9cf3, 0x4ad5, 0x4ad5, 
  0x4ad5, 0x4ad5, 0x9cf3, 0x9cf3, 0x9cf3, 0x9cf3, 0x4209, 0x4209, 0x4209, 0x4209, 0xa514, 0xa514, 0xa514, 0xa514, 0x4ad5, 0x4ad5, 0x4ad5, 0x4ad5, 0xa514, 0xa514, 0xa514, 0xa514, 0x4209, 0x4209, 
  0x4209, 0x4209, 0xa534, 0xa534, 0xa534, 0xa534, 0x4ad5, 0x4ad5, 0x4ad5, 0x4ad5, 0xa534, 0xa534, 0xa534, 0xa534, 0x4209, 0x4209, 0x4209, 0x4209, 0xad55, 0xad55, 0xad55, 0xad55, 0x4ad5, 0x4ad5, 
  0x4ad5, 0x4ad5, 0xad55, 0xad55, 0xad55, 0xad55, 0x4209, 0x4209, 0x4209, 0x4209, 0xad75, 0x4af5, 0x4ad5, 0x4ad5, 0x4ad5, 0x4ad5, 0x4ad5, 0x4ad5, 0x4ad5, 0x4ad5, 0x4af5, 0xad75, 0x4209, 0x4209, 
  0x4209, 0x4209, 0xb596, 0x4af5, 0x4ad5, 0x4ad5, 0x4ad5, 0x4ad5, 0x4ad5, 0x4ad5, 0x4ad5, 0x4ad5, 0x4af5, 0xb596, 0x4209, 0x4209, 0x4209, 0x4209, 0xb5b6, 0xb5b6, 0x4af5, 0x4ad5, 0x4ad5, 0x4ad5, 
  0x4ad5, 0x4ad5, 0x4ad5, 0x4af5, 0xb5b6, 0xb5b6, 0x4209, 0x4209, 0x4209, 0x4209, 0xbdd7, 0xbdd7, 0xbdd7, 0x4af5, 0x4ad5, 0x4ad5, 0x4ad5, 0x4ad5, 0x4af5, 0xbdd7, 0xbdd7, 0xbdd7, 0x4209, 0x4209, 
  0x4209, 0x4209, 0xbdf7, 0xbdf7, 0xbdf7, 0xbdf7, 0x4af5, 0x4ad5, 0x4ad5, 0x4af5, 0xbdf7, 0xbdf7, 0xbdf7, 0xbdf7, 0x4209, 0x4209, 0x4209, 0x4209, 0xc618, 0xc618, 0xc618, 0xc618, 0xc618, 0x4af5, 
  0x4af5, 0xc618, 0xc618, 0xc618, 0xc618, 0xc618, 0x4209, 0x4209, 0x4209, 0x4209, 0xc638, 0xc638, 0xc638, 0xc638, 0xc638, 0xc638, 0xc638, 0xc638, 0xc638, 0xc638, 0xc638, 0xc638, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 
  0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x630e, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 
  0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x4209, 0x630e
};
#define Barstart 26
#define Barstop 126

Block world[WorldW][WorldH];

uint32_t Random(uint32_t Min, uint32_t Max) {
  return Min + (esp_random() % (Max-Min+1));
}

void generateWorld() {
  tft.print("Generating...");
  int range = WorldH-Surface;
  int persentOre = range/numOre;
  for (int k = 0; k < Surface; k++) {
    for (int n = 0; n < WorldW; n++) {
      world[n][k] = {8, 0b00010100};     //генерируем небо
    }
  }
  for (int i = 0; i < WorldW; i++) {
    world[i][Surface] = {0, 0b00000100};      //генерируем траву
  }
  for (int g = Surface+1; g < WorldH; g++) {
    for (int v = 0; v < WorldW; v++) {
      uint32_t rnd = Random(0, 1000);
      world[v][g] = {1, 0b00000100};      //генерируем землю
      if (rnd <= chanceStone) {
        world[v][g] = {2, 0b00001100};         //генерируем камни 
      }
      if (rnd <= chanceOre1 && g <= persentOre*3+Surface) {
        world[v][g] = {4, 0b00000100};         //генерируем руду1
      }
      if (rnd <= chanceOre2 && g <= persentOre*2+Surface) {
        world[v][g] = {5, 0b00000100};         //генерируем руду2
      }
      if (rnd <= chanceOre3 && g <= persentOre+Surface) {
        world[v][g] = {6, 0b00000100};         //генерируем руду3
      }
      if (rnd <= chanceOre4) {
        world[v][g] = {7, 0b00000100};         //генерируем руду4
      }
        
    }
  }
  for (int i = 0; i < WorldW; i++) {
    world[i][WorldH-1] = {2, 0b00001100};      //камень снизу мира
  }
  return;
}

void drawBitmp(int x, int y, uint8_t type, int scale) {
  int counter = 0;
  for (int k = y; k < y+8*scale; k += scale) {
    for (int i = x; i < x+8*scale; i += scale) {
      tft.fillRect(i, k, scale, scale, sprites[type][counter]);
      counter++;
    }
  }
  return;
}

void drawBar(int persent) {
  tft.drawRGBBitmap(0, 0, Depth_Bar_16x128, 16, 128);
  tft.fillRect(3, Barstart, 10, persent, 0x8eeb);
  if (persent >= 100) persent = 99;
  tft.setCursor(3, 3);
  if (persent < 10) tft.setCursor(6, 3);
  tft.setTextColor(ST77XX_WHITE);
  tft.print(persent);
  return;
}

void render(int scale) {
  tft.fillScreen(ST77XX_BLACK);
  uint8_t blockType = 0;
  int blockX = 0;
  int blockY = 0;
  for (int i = playerX-(((SCREEN_WIDTH-16)/(8*scale))/2); i <= playerX+1+((SCREEN_WIDTH-16)/(8*scale))/2; i++) {
    for (int n = playerY-(SCREEN_HEIGHT/(8*scale))/2; n <= playerY+(SCREEN_HEIGHT/(8*scale))/2; n++) {
      Serial.print(i);
      Serial.print("/");
      Serial.print(n);
      Serial.print("/");
      Serial.print(world[i][n].type);
      Serial.print("/");
      Serial.print(blockX);
      Serial.print("/");
      Serial.print(blockY);
      Serial.print("/");
      Serial.print(world[i][n].flags, BIN);
      Serial.print(" ");
      if (i > WorldW-1) {
        blockType = world[(i-(WorldW-1))-1][n].type;
      }else if (i < 0) {
        blockType = world[i+WorldW][n].type;
      }else{
        blockType = world[i][n].type;
      }
      if (n < 0) {
        blockType = 8;
      }
      drawBitmp(blockX*(8*scale)+16, blockY*(8*scale), blockType, scale);
      blockY++;
    }
    blockY = 0;
    Serial.println();
    blockX++;
  }
  drawBitmp(80, 64, numOfSprites-1, scale);   //player
  float persent1 = (float)(WorldH-Surface)/100;
  float persent2 = (float)(playerY-Surface);
  if (playerY-Surface < 0 ) persent2 = 0;
  float persent3 = persent1*persent2;
  drawBar((int)persent3);
  tft.setCursor(32, 0);
  tft.print("X");
  tft.print(playerX);
  tft.print("/Y");
  tft.print(playerY);
  return;
}



bool canFall(uint8_t x, uint8_t y) {
  if (y < WorldH-1) {
    if (y+1 == playerY) return 0;
    if (world[x][y+1].flags & NO_COLLISION || world[x][y+1].flags & BROKEN) {
      return 1;
    }
  }
  return 0;
}

bool canFall(uint8_t x, uint8_t y, bool diagonal) {
  if (y < WorldH-1) {
    if (x > 0 && x < WorldW-1) {
      if (diagonal) {
        if (y+1 == playerY && x+1 == playerX) return 0;
        if (world[x+1][y+1].flags & NO_COLLISION || world[x+1][y+1].flags & BROKEN) return 1;
      }else {
        if (y+1 == playerY && x-1 == playerX) return 0;
        if (world[x-1][y+1].flags & NO_COLLISION || world[x-1][y+1].flags & BROKEN) return 1;
      }
    }else{
      if (x == 0) {
        if (diagonal) {
          if (y+1 == playerY && x+1 == playerX) return 0;
          if (world[x+1][y+1].flags & NO_COLLISION || world[x+1][y+1].flags & BROKEN) return 1;
        }else{
          if (y+1 == playerY && playerX == WorldW-1) return 0;
          if (world[WorldW-1][y+1].flags & NO_COLLISION || world[WorldW-1][y+1].flags & BROKEN) return 1;
        }
      }else if (x == WorldW-1) {
        if (diagonal) {
          if (y+1 == playerY && playerX == 0) return 0;
          if (world[0][y+1].flags & NO_COLLISION || world[0][y+1].flags & BROKEN) return 1;
        }else{
          if (y+1 == playerY && playerX == x-1) return 0;
          if (world[x-1][y+1].flags & NO_COLLISION || world[x-1][y+1].flags & BROKEN) return 1;
        }
      }
    }
  }
  return 0;
}

void addToBuffer(uint8_t x, uint8_t y) {
  if (activeCount == liquidBufferSize) return;
  liquidBuffer[activeCount][0] = x;
  liquidBuffer[activeCount][1] = y;
  world[x][y].flags |= ADD_BUFFER;
  activeCount++;
  return;
}

void deleteFromBuffer(uint8_t id) {
  if (activeCount == 0) return;
  world[liquidBuffer[id][0]][liquidBuffer[id][1]].flags &= ~ADD_BUFFER;
  if (id != activeCount-1) {
    liquidBuffer[id][0] = liquidBuffer[activeCount-1][0];
    liquidBuffer[id][1] = liquidBuffer[activeCount-1][1];
    activeCount--;
  }else{
    activeCount--;
  }
  return;
}

void checkLiquidBlocks(uint8_t x, uint8_t y) {        //указываем блок от которого идет проверка
  if (y > 0) {
    if (x > 0 && x < WorldW-1) {
      if (world[x-1][y-1].flags & MOVABLE && !(world[x-1][y-1].flags & ADD_BUFFER)) addToBuffer(x-1, y-1);
      if (world[x][y-1].flags & MOVABLE && !(world[x][y-1].flags & ADD_BUFFER)) addToBuffer(x, y-1);
      if (world[x+1][y-1].flags & MOVABLE && !(world[x+1][y-1].flags & ADD_BUFFER)) addToBuffer(x+1, y-1);
    }else if (x == 0) {
      if (world[WorldW-1][y-1].flags & MOVABLE && !(world[WorldW-1][y-1].flags & ADD_BUFFER)) addToBuffer(WorldW-1, y-1);
      if (world[x][y-1].flags & MOVABLE && !(world[x][y-1].flags & ADD_BUFFER)) addToBuffer(x, y-1);
      if (world[x+1][y-1].flags & MOVABLE && !(world[x+1][y-1].flags & ADD_BUFFER)) addToBuffer(x+1, y-1);
    }else if (x == WorldW-1) {
      if (world[x-1][y-1].flags & MOVABLE && !(world[x-1][y-1].flags & ADD_BUFFER)) addToBuffer(x-1, y-1);
      if (world[x][y-1].flags & MOVABLE && !(world[x][y-1].flags & ADD_BUFFER)) addToBuffer(x, y-1);
      if (world[0][y-1].flags & MOVABLE && !(world[0][y-1].flags & ADD_BUFFER)) addToBuffer(0, y-1);
    }
  }
  return;
}



void liquidTick() {
  if (activeCount == 0) return;            //все координаты в массиве будут обязательно в начале, если он пуст значит и буффер пуст
  for (int i = activeCount-1; i >= 0; i--) {
    uint8_t x = liquidBuffer[i][0];
    uint8_t y = liquidBuffer[i][1];
    if (x >= playerX-4 && x <= playerX+4 && y >= playerY-4 && y <= playerY+3) needRender = 1;
    if (canFall(x, y)) {
      world[x][liquidBuffer[i][1]+1].type = world[x][liquidBuffer[i][1]].type;
      world[x][liquidBuffer[i][1]+1].flags = world[x][liquidBuffer[i][1]].flags;
      world[x][y].type = (y < Surface) ? 8 : 9;
      world[x][y].flags = 0;
      world[x][y].flags |= NO_COLLISION;
      checkLiquidBlocks(x, y);
      liquidBuffer[i][1] += 1;
    }else {
      bool side = random(0, 2); // 0 - влево, 1 - вправо
      if (canFall(x, y, side)) {
        // Вычисляем целевой X с учетом заворота мира
        uint8_t tx = (side) ? ((x + 1) % WorldW) : (x > 0 ? x - 1 : WorldW - 1);
        
        world[tx][y+1].type = world[x][y].type;
        world[tx][y+1].flags = world[x][y].flags;
        
        world[x][y].type = (y < Surface) ? 8 : 9;
        world[x][y].flags = 0;
        world[x][y].flags = NO_COLLISION;

        checkLiquidBlocks(x, y);
        liquidBuffer[i][0] = tx;   // Обновляем X в буфере
        liquidBuffer[i][1] = y + 1; // Обновляем Y в буфере
      } 
      else if (canFall(x, y, !side)) { // Проверяем другую сторону
        uint8_t tx = (!side) ? ((x + 1) % WorldW) : (x > 0 ? x - 1 : WorldW - 1);
        
        world[tx][y+1].type = world[x][y].type;
        world[tx][y+1].flags = world[x][y].flags;
        
        world[x][y].type = (y < Surface) ? 8 : 9;
        world[x][y].flags = 0;
        world[x][y].flags = NO_COLLISION;

        checkLiquidBlocks(x, y);
        liquidBuffer[i][0] = tx;
        liquidBuffer[i][1] = y + 1;
      } 
      else {
        deleteFromBuffer(i);
      }
    }
  }
}



void setup() {
  Serial.begin(115200);
  Serial.print("Testing random... ");
  Serial.print(Random(32, 64));
  
  playerX = Random(0, WorldW-1);
  tft.initR(INITR_BLACKTAB);      // Init ST7735S chip, black tab
  tft.setSPISpeed(70000000);
  tft.fillScreen(ST77XX_BLACK);
  tft.setRotation(3);
  pinMode(but1, INPUT);
  pinMode(but2, INPUT);
  pinMode(but3, INPUT);
  tft.setTextSize(1);   
  tft.setTextColor(ST7735_WHITE);
  tft.setCursor(32,0);
  //mainMenu();
  generateWorld();
  world[60][Surface-1] = {2, 0b00001100};
  world[59][Surface-1] = {3, 0b00001100};
  world[58][Surface-1] = {4, 0b00001100};
  world[57][Surface-1] = {5, 0b00001100};
  world[56][Surface-1] = {6, 0b00001100};
  world[55][Surface-1] = {7, 0b00001100};
  world[playerX][29] = {11, MOVABLE};
  render(2);
}

void loop() {
  if (millis()-renderTmr >= 30) {
    renderTmr = millis();
    if (needRender) render(2);
    needRender = 0;
  }
  if (millis()-liquidTmr >= liquidUpdate) {
    liquidTmr = millis();
    liquidTick();
  }
  if (millis()-gravityTmr >= 25) {
    gravityTmr = millis();
    if (((world[playerX][playerY+1].flags & (1<<0)) || (world[playerX][playerY+1].flags & (1<<4))) && (world[playerX][playerY+1].type != 10)) {
      checkLiquidBlocks(playerX, playerY);
      playerY++;
      checkLiquidBlocks(playerX, playerY);
      needRender = 1;
    }
  }
  if (millis()-tmr >= 300) {
    tmr = millis();
    if (analogRead(joyx) >= 2500) {
      if (playerX == 0) {
        if (world[WorldW-1][playerY].flags & (1<<0) || world[WorldW-1][playerY].flags & (1<<4)) {
          checkLiquidBlocks(playerX, playerY);
          playerX = WorldW-1;
          checkLiquidBlocks(playerX, playerY);
          needRender = 1;
      }else if ((world[WorldW-1][playerY].flags & (1<<3)) == 0) {
        world[WorldW-1][playerY].flags |= (1<<0);
        world[WorldW-1][playerY].type = 9;
        checkLiquidBlocks(playerX, playerY);
        playerX = WorldW-1;
        checkLiquidBlocks(playerX, playerY);
        needRender = 1;
      }
      }else if (world[playerX-1][playerY].flags & (1<<0) || world[playerX-1][playerY].flags & (1<<4)) {
        checkLiquidBlocks(playerX, playerY);
        playerX--;
        checkLiquidBlocks(playerX, playerY);
        needRender = 1;
      }else if ((world[playerX-1][playerY].flags & (1<<3)) == 0) {
        world[playerX-1][playerY].flags |= (1<<0);
        world[playerX-1][playerY].type = 9;
        checkLiquidBlocks(playerX, playerY);
        playerX--;
        checkLiquidBlocks(playerX, playerY);
        needRender = 1;
      }
    }else if (analogRead(joyx) <= 800) {
      if (playerX == 127) {
        if (world[0][playerY].flags & (1<<0) || world[0][playerY].flags & (1<<4)) {
          checkLiquidBlocks(0, playerY);
          playerX = 0;
          needRender = 1;
        }else if ((world[0][playerY].flags & (1<<3)) == 0) {
          world[0][playerY].flags |= (1<<0);
          world[0][playerY].type = 9;
          checkLiquidBlocks(playerX, playerY);
          playerX = 0;
          checkLiquidBlocks(playerX, playerY);
          needRender = 1;
        }
      }else if (world[playerX+1][playerY].flags & (1<<0) || world[playerX+1][playerY].flags & (1<<4)) {
        checkLiquidBlocks(playerX, playerY);
        playerX++;
        checkLiquidBlocks(playerX, playerY);
        needRender = 1;
      }else if ((world[playerX+1][playerY].flags & (1<<3)) == 0) {
        world[playerX+1][playerY].flags |= (1<<0);
        world[playerX+1][playerY].type = 9;
        checkLiquidBlocks(playerX, playerY);
        playerX++;
        checkLiquidBlocks(playerX, playerY);
        needRender = 1;
      }
    }
    if (analogRead(joyy) >= 2500) {
      if (playerY > 0) {
        if ((world[playerX][playerY-1].flags & (1<<0)) || (world[playerX][playerY-1].flags & (1<<4))) {
          world[playerX][playerY].flags = 0b00101;
          world[playerX][playerY].type = 10;
          checkLiquidBlocks(playerX, playerY);
          playerY--;
          checkLiquidBlocks(playerX, playerY);
          needRender = 1;
        }else if ((world[playerX][playerY-1].flags & (1<<3)) == 0) {
          world[playerX][playerY].flags = 0b00101;
          world[playerX][playerY].type = 10;
          world[playerX][playerY-1].flags |= (1<<0);
          world[playerX][playerY-1].type = 9;
          checkLiquidBlocks(playerX, playerY);
          playerY--;
          checkLiquidBlocks(playerX, playerY);
          needRender = 1;
        }else if (world[playerX][playerY-1].type == 10) {
          checkLiquidBlocks(playerX, playerY);
          playerY--;
          checkLiquidBlocks(playerX, playerY);
          needRender = 1;
        }
      }else{
        tft.setTextSize(1);
        tft.setCursor(64,16);
        tft.setTextColor(ST7735_BLACK);
        tft.print("too far");
      }
    }else if (analogRead(joyy) <= 800) {
      if (world[playerX][playerY+1].flags & (1<<0) || world[playerX][playerY+1].flags & (1<<4)) {
        checkLiquidBlocks(playerX, playerY);
        playerY++;
        checkLiquidBlocks(playerX, playerY);
        needRender = 1;
      }else if ((world[playerX][playerY+1].flags & (1<<3)) == 0) {
        world[playerX][playerY+1].flags |= (1<<0);
        world[playerX][playerY+1].type = 9;
        checkLiquidBlocks(playerX, playerY);
        playerY++;
        checkLiquidBlocks(playerX, playerY);
        needRender = 1;
      }
    }
  }
}
